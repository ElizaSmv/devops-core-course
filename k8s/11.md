# Kubernetes Secrets and Hashicorp Vault

## Secrets using `kubectl`

#### Create Secret
```shell
$ kubectl create secret generic new-secret  --from-literal=username=admin  --from-literal=password='kuber-pass'
secret/new-secret created
```

#### Check all secrets
```shell
$ kubectl get secrets
NAME                               TYPE                 DATA   AGE
new-secret                         Opaque               2      79s
sh.helm.release.v1.javascript.v1   helm.sh/release.v1   1      6d13h
sh.helm.release.v1.python.v1       helm.sh/release.v1   1      6d20h
```

#### Decode secret

```shell
$ kubectl get secret new-secret -o jsonpath='{.data.password}' | base64 -d
kuber-pass                              
```

## Manage Secrets with Helm

#### Create `secrets.yaml` file within templates folder

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: helm-secret
  labels:
    app: app-py-helm
    chart: '{{ .Chart.Name }}-{{ .Chart.Version }}'
    release: '{{ .Release.Name }}'
    heritage: '{{ .Release.Service }}'
type: Opaque
data:
  password: {{ .Values.password | b64enc | quote}}
```

#### Add `env` part to `deployment.yaml`

This is the added part.

```yaml
env:
- name: MY_PASSWORD
  valueFrom:
  secretKeyRef:
  key: password
  name: helm-secret
```

#### Update Helm deployment

```shell
$  helm secrets install app-py-helm ./app-py-helm/ -n default -f ./secrets.yaml
NAME: app-py-helm
LAST DEPLOYED: Wed Nov 15 01:17:46 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-py-helm,app.kubernetes.io/instance=app-py-helm" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
./secrets.yaml.dec
```

#### Retrieve the list of pods using the command `kubectl get po`

```shell
$ kubectl get po
NAME                                      READY   STATUS    RESTARTS      AGE
app-py-helm-557fb46687-gn9lr              1/1     Running   0             37s
app-py-helm-557fb46687-gn9lr              1/1     Running   0             37s
app-py-helm-557fb46687-gn9lr              1/1     Running   0             37s
```

#### Verify your secret inside the pod

```shell
kubectl exec app-py-helm-557fb46687-gn9lr -- printenv | grep MY_PASS
MY_PASSWORD=devops
```
